generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RelationshipStatus {
  active
  ended
}

enum RelationshipStage {
  dating
  committed
  engaged
  married
}

enum InviteStatus {
  pending
  accepted
  expired
  cancelled
}

enum ActivityStyle {
  chill
  active
  surprise
}

enum BudgetLevel {
  low
  medium
  high
}

enum IdeaType {
  LOCAL
  FOOD
  MOVIE
  HOME
}

enum IdeaSource {
  CURATED
  GENERATED
  USER_SAVED
}

enum NoteType {
  TEXT
  VOICE
  VIDEO
}

model User {
  id           String      @id @default(cuid())
  email        String      @unique
  passwordHash String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  relationshipsA Relationship[] @relation("UserARelationships")
  relationshipsB Relationship[] @relation("UserBRelationships")
  invites      RelationshipInvite[] @relation("UserInvites")
  inviteeInvites RelationshipInvite[] @relation("Invitee")
  checkins     Checkin[]
  preferences  Preference?
  savedIdeas   SavedIdea[]
  ideaRequests IdeaRequest[]
  notes        Note[]
}

model Relationship {
  id         String              @id @default(cuid())
  userAId    String
  userBId    String
  status     RelationshipStatus  @default(active)
  stage      RelationshipStage   @default(dating)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  endedAt    DateTime?
  invites    RelationshipInvite[]
  checkins   Checkin[]
  savedIdeas SavedIdea[]
  ideaRequests IdeaRequest[]
  notes       Note[]

  userA User @relation("UserARelationships", fields: [userAId], references: [id])
  userB User @relation("UserBRelationships", fields: [userBId], references: [id])

  @@unique([userAId, userBId])
}

model RelationshipInvite {
  id           String        @id @default(cuid())
  code         String        @unique
  status       InviteStatus  @default(pending)
  inviterId    String
  inviteeId    String?
  relationshipId String?
  expiresAt    DateTime
  acceptedAt   DateTime?
  createdAt    DateTime      @default(now())

  inviter      User          @relation("UserInvites", fields: [inviterId], references: [id])
  invitee      User?         @relation("Invitee", fields: [inviteeId], references: [id])
  relationship Relationship? @relation(fields: [relationshipId], references: [id])
}

model Checkin {
  id              String        @id @default(cuid())
  userId          String
  relationshipId  String?
  moodLevel       Int
  note            String?
  shared          Boolean       @default(false)
  energyLevel     Int?
  createdAt       DateTime      @default(now())

  user          User          @relation(fields: [userId], references: [id])
  relationship  Relationship? @relation(fields: [relationshipId], references: [id])

  @@index([relationshipId])
}

model Note {
  id              String        @id @default(cuid())
  userId          String
  relationshipId  String?
  type            NoteType
  content         String?
  mediaUrl        String?
  createdAt       DateTime      @default(now())

  user         User          @relation(fields: [userId], references: [id])
  relationship Relationship? @relation(fields: [relationshipId], references: [id])

  @@index([relationshipId])
  @@index([userId, createdAt])
}

model Preference {
  id             String          @id @default(cuid())
  userId         String          @unique
  activityStyle  ActivityStyle
  budgetLevel    BudgetLevel
  energyLevel    Int
  stage          RelationshipStage
  foodTypes      String[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model SavedIdea {
  id              String        @id @default(cuid())
  userId          String
  relationshipId  String?
  ideaId          String
  notes           String?
  createdAt       DateTime      @default(now())

  user         User          @relation(fields: [userId], references: [id])
  relationship Relationship? @relation(fields: [relationshipId], references: [id])
  idea         Idea          @relation(fields: [ideaId], references: [id], onDelete: Cascade)

  @@unique([userId, ideaId])
  @@index([relationshipId])
}

model Idea {
  id              String        @id @default(cuid())
  type            IdeaType
  title           String
  description     String?
  category        String?
  source          IdeaSource    @default(CURATED)
  metadata        Json          @default("{}")
  createdAt       DateTime      @default(now())

  savedIdeas SavedIdea[]

  @@index([type])
  @@index([source])
}

model IdeaRequest {
  id              String        @id @default(cuid())
  userId          String
  relationshipId  String?
  type            IdeaType
  params          Json
  createdAt       DateTime      @default(now())

  user         User          @relation(fields: [userId], references: [id])
  relationship Relationship? @relation(fields: [relationshipId], references: [id])

  @@index([userId])
  @@index([type])
}
