generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RelationshipStatus {
  active
  ended
}

enum RelationshipStage {
  dating
  committed
  engaged
  married
}

enum InviteStatus {
  pending
  accepted
  expired
  cancelled
}

enum ActivityStyle {
  chill
  active
  surprise
}

enum BudgetLevel {
  low
  medium
  high
}

enum IdeaType {
  LOCAL
  FOOD
  MOVIE
  HOME
}

enum IdeaSource {
  CURATED
  GENERATED
  USER_SAVED
}

enum NoteType {
  TEXT
  VOICE
  VIDEO
}

enum MoodState {
  energetic
  calm
  playful
  romantic
  adventurous
  relaxed
  stressed
  happy
}

enum TimeOfDay {
  morning
  afternoon
  evening
  night
}

enum WeatherPreference {
  indoor
  outdoor
  any
}

enum OAuthProvider {
  email
  google
  apple
}

enum GoalStatus {
  active
  completed
  failed
}

enum MessageType {
  text
  image
  voice
  assistance_request
}

model User {
  id           String      @id @default(cuid())
  email        String      @unique
  passwordHash String?
  oauthProvider OAuthProvider @default(email)
  oauthId      String?
  emailVerified Boolean     @default(false)
  avatarUrl    String?
  setupCompleted Boolean    @default(false)
  isTestUser   Boolean     @default(false)
  testTag      String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  relationshipsA Relationship[] @relation("UserARelationships")
  relationshipsB Relationship[] @relation("UserBRelationships")
  invites      RelationshipInvite[] @relation("UserInvites")
  inviteeInvites RelationshipInvite[] @relation("Invitee")
  checkins     Checkin[]
  preferences  Preference?
  savedIdeas   SavedIdea[]
  ideaRequests IdeaRequest[]
  notes        Note[]
  moodCheckins MoodCheckin[]
  activityPreferences ActivityPreferences?
  emailVerifications EmailVerification[]
  plans        Plan[]
  workoutGoals WorkoutGoal[]
  workoutLogs  WorkoutLog[]
  groceryItemsAdded GroceryItem[] @relation("ItemAddedBy")
  groceryItemsVetoed GroceryItem[] @relation("ItemVetoed")
  messagesSent ChatMessage[]
  
  @@index([oauthProvider, oauthId])
  @@index([isTestUser, testTag])
}

model Relationship {
  id         String              @id @default(cuid())
  userAId    String
  userBId    String
  status     RelationshipStatus  @default(active)
  stage      RelationshipStage   @default(dating)
  isTest     Boolean             @default(false)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  endedAt    DateTime?
  invites    RelationshipInvite[]
  checkins   Checkin[]
  savedIdeas SavedIdea[]
  ideaRequests IdeaRequest[]
  notes       Note[]
  plans       Plan[]
  workoutGoals WorkoutGoal[]
  workoutBets  WorkoutBet[]
  groceryLists GroceryList[]
  chatMessages ChatMessage[]

  userA User @relation("UserARelationships", fields: [userAId], references: [id])
  userB User @relation("UserBRelationships", fields: [userBId], references: [id])

  @@unique([userAId, userBId])
  @@index([isTest])
}

model RelationshipInvite {
  id           String        @id @default(cuid())
  code         String        @unique
  status       InviteStatus  @default(pending)
  inviterId    String
  inviteeId    String?
  relationshipId String?
  expiresAt    DateTime
  acceptedAt   DateTime?
  createdAt    DateTime      @default(now())

  inviter      User          @relation("UserInvites", fields: [inviterId], references: [id])
  invitee      User?         @relation("Invitee", fields: [inviteeId], references: [id])
  relationship Relationship? @relation(fields: [relationshipId], references: [id])
}

model Checkin {
  id              String        @id @default(cuid())
  userId          String
  relationshipId  String?
  moodLevel       Int
  note            String?
  shared          Boolean       @default(false)
  energyLevel     Int?
  moodColor       String?
  emotionLabel    String?
  createdAt       DateTime      @default(now())

  user          User          @relation(fields: [userId], references: [id])
  relationship  Relationship? @relation(fields: [relationshipId], references: [id])

  @@index([relationshipId])
  @@index([userId, createdAt])
}

model Note {
  id              String        @id @default(cuid())
  userId          String
  relationshipId  String?
  type            NoteType
  content         String?
  mediaUrl        String?
  createdAt       DateTime      @default(now())

  user         User          @relation(fields: [userId], references: [id])
  relationship Relationship? @relation(fields: [relationshipId], references: [id])

  @@index([relationshipId])
  @@index([userId, createdAt])
}

model Preference {
  id             String          @id @default(cuid())
  userId         String          @unique
  activityStyle  ActivityStyle
  budgetLevel    BudgetLevel
  energyLevel    Int
  stage          RelationshipStage
  foodTypes      String[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model SavedIdea {
  id              String        @id @default(cuid())
  userId          String
  relationshipId  String?
  ideaId          String
  notes           String?
  createdAt       DateTime      @default(now())

  user         User          @relation(fields: [userId], references: [id])
  relationship Relationship? @relation(fields: [relationshipId], references: [id])
  idea         Idea          @relation(fields: [ideaId], references: [id], onDelete: Cascade)

  @@unique([userId, ideaId])
  @@index([relationshipId])
}

model Idea {
  id              String        @id @default(cuid())
  type            IdeaType
  title           String
  description     String?
  category        String?
  source          IdeaSource    @default(CURATED)
  metadata        Json          @default("{}")
  createdAt       DateTime      @default(now())

  savedIdeas SavedIdea[]
  plans      Plan[]

  @@index([type])
  @@index([source])
}

model IdeaRequest {
  id              String        @id @default(cuid())
  userId          String
  relationshipId  String?
  type            IdeaType
  params          Json
  createdAt       DateTime      @default(now())

  user         User          @relation(fields: [userId], references: [id])
  relationship Relationship? @relation(fields: [relationshipId], references: [id])

  @@index([userId])
  @@index([type])
}

model MoodCheckin {
  id              String        @id @default(cuid())
  userId          String
  moodState       MoodState
  createdAt       DateTime      @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model ActivityPreferences {
  id                  String        @id @default(cuid())
  userId              String        @unique
  interests           String[]      @default([])
  dietaryRestrictions String[]      @default([])
  hasChildren         Boolean       @default(false)
  accessibilityNeeds  String[]      @default([])
  budgetLevel         BudgetLevel   @default(medium)
  maxDistance         Int           @default(10)
  preferredTimeOfDay  TimeOfDay[]   @default([])
  weatherPreference   WeatherPreference @default(any)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model EmailVerification {
  id         String   @id @default(cuid())
  userId     String
  code       String
  expiresAt  DateTime
  verified   Boolean  @default(false)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, verified])
  @@index([code, expiresAt])
}

model Plan {
  id              String   @id @default(cuid())
  userId          String
  relationshipId  String?
  ideaId          String?
  title           String
  description     String?
  placeId         String?
  address         String?
  lat             Float?
  lng             Float?
  websiteUrl      String?
  phoneNumber     String?
  priceLevel      Int?
  scheduledDate   DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  relationship Relationship? @relation(fields: [relationshipId], references: [id])
  idea         Idea?         @relation(fields: [ideaId], references: [id])

  @@index([userId])
  @@index([relationshipId])
}

model WorkoutGoal {
  id              String      @id @default(cuid())
  userId          String
  relationshipId  String?
  title           String
  description     String?
  targetMetric    String
  targetValue     Int
  startDate       DateTime
  endDate         DateTime
  status          GoalStatus  @default(active)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  user            User         @relation(fields: [userId], references: [id])
  relationship    Relationship? @relation(fields: [relationshipId], references: [id])
  bets            WorkoutBet[]
  logs            WorkoutLog[]

  @@index([userId])
  @@index([relationshipId])
  @@index([status])
}

model WorkoutBet {
  id              String       @id @default(cuid())
  relationshipId  String
  goalId          String
  wagerDescription String
  createdAt       DateTime     @default(now())
  
  relationship    Relationship @relation(fields: [relationshipId], references: [id])
  goal            WorkoutGoal  @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([relationshipId])
  @@index([goalId])
}

model WorkoutLog {
  id              String       @id @default(cuid())
  goalId          String
  userId          String
  amount          Int
  notes           String?
  loggedAt        DateTime     @default(now())
  
  goal            WorkoutGoal  @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id])

  @@index([goalId])
  @@index([userId])
}

model GroceryList {
  id              String       @id @default(cuid())
  relationshipId  String
  name            String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  relationship    Relationship @relation(fields: [relationshipId], references: [id])
  items           GroceryItem[]

  @@index([relationshipId])
}

model GroceryItem {
  id              String       @id @default(cuid())
  listId          String
  addedBy         String
  name            String
  quantity        Int          @default(1)
  unit            String?
  vetoed          Boolean      @default(false)
  vetoedBy        String?
  vetoReason      String?
  completedAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  list            GroceryList  @relation(fields: [listId], references: [id], onDelete: Cascade)
  addedByUser     User         @relation("ItemAddedBy", fields: [addedBy], references: [id])
  vetoByUser      User?        @relation("ItemVetoed", fields: [vetoedBy], references: [id])

  @@index([listId])
  @@index([addedBy])
}

model ChatMessage {
  id              String       @id @default(cuid())
  relationshipId  String
  senderId        String
  content         String
  type            MessageType  @default(text)
  mediaUrl        String?
  readAt          DateTime?
  createdAt       DateTime     @default(now())
  
  relationship    Relationship @relation(fields: [relationshipId], references: [id])
  sender          User         @relation(fields: [senderId], references: [id])
  
  @@index([relationshipId, createdAt])
  @@index([senderId])
}
